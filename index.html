<!doctype html>
<html lang="nl">

	<head>
		<meta charset="utf-8">

		<title>Elasticsearch: you know, for search.</title>

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/moon.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<style type="text/css">
		.reveal section img.raw {background: none; border: none; box-shadow: none;}
		.reveal h1.emph {
			color: black;
			text-shadow: 0 0 80px #FFFFFF;
		}
		.reveal table {
			width: 80%;
			margin-left: auto;
			margin-right: auto;
		}
		.reveal h3.mtop, .reveal h2.mtop, .reveal h4.mtop, .reveal p.mtop {
			 margin-top: 1.1em
		}



		.reveal .schema div.s {
			float: left;
			margin-left: 0.6em;
			margin-right: 0.6em;
		}
		.reveal div.arrow {			
			width: 6em;
			text-align: center;
		}
		.reveal div.arrow p {
			background: transparent url() no-repeat 0 100%;
		}
		.reveal div.buffer {
			border: 1px solid yellow; 
			border-radius: 3px;
			padding: 0.3em 1em;
		}
		.reveal div.buffer > h5 {
			clear: both;
		}
		.reveal div.doc {
			width: 1em; 
			height: 1em; 
    		border-radius: 0.5em;
    		background-color: yellow;
    		text-indent: -9999px;
    		float: left;
    		margin: 0.1em 0.1em;
    		border: 2px solid #002b36
		}
		.reveal .flush div.doc {
			margin-right: -0.6em;
		}
		.reveal div.segment {
			width: 4em;
			border: 1px solid yellow; 
			border-radius: 3px;
			background-color: yellow;				
			padding: 0.3em 1em;	
			margin-top: 1em;	
			border: 2px solid #002b36
		}
		.reveal div.segment > h5 {
			margin: 2px;
			color: black;
		}
		.reveal div.segment2 {
			margin-left: 1.1em !IMPORTANT; 
			margin-top: -1.5em;
		}
		.reveal div.segment3 {
			margin-left: 1.4em !IMPORTANT; 
			margin-top: -1.1em;
		}

		.reveal div.doc ~ .reveal div.flush.visible {
			opacity: 0;
		}

		.reveal div.arrow {
		    width:150px;
		    margin:5px auto;
		}

		.reveal div.line {
		    margin-top:8px;
		    width:120px;
		    background:white;
		    height:4px;
		    float:left;
		}
		.reveal div.point {	
		    width: 0; 
			height: 0; 
			border-top: 10px solid transparent;
			border-bottom: 10px solid transparent;
			border-left: 30px solid white;
		    float:right;
		}
		</style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<div class="slides">
				<section>
					<h1>Elasticsearch</h1>
					<h4>Distributed full-text search</h4>
					<p>
						<small>Tim Van Laer</small>
					</p>
				</section>

				<section>
					<h2>Agenda</h2>
					<ol>
						<li>Wat is Elasticsearch?</li>
						<li>Iets over Lucene</li>
						<li>Demo: KBCS Research Documents</li>
						<li>Index en Search API</li>
						<li>In productie</li>
					</ol>
				</section>

				<section>
					<h2>Wat is Elasticsearch?</h2>
					<ul>
						<li>Document oriented search engine<br>
							<small>JSON based, Apache Lucene</small></li>
						<li>Schema free</li>
						<li>Distributed<br>
							<small>Scales Up + Out, Highly Available</small></li>
						<li>Multitenancy<br>
							<small>Dynamisch aanmaken en verwijderen van indices</small></li>
						<li>API centric &amp; RESTful</li>
					</ul>
				</section>	

				<section>
					<h2>Wat kan Elasticsearch?</h2>
				</section>

				<section data-background="http://erron.fr/wp-content/uploads/2013/04/wheres-wally-1.jpg" data-background-transition="slide">
					<h1 style="color:black">Zoeken</h1>
					<h2 style="color:black">Gestructureerd en ongestructureerd</h2>
					<aside class="notes">
						<p>Ongestructureerd: Alle documenten met 'goud' in, alle bedrijven die iets doen met grondwater...
						Gestructureerd: Alle bedrijfen opgericht tussen 2010 en 2014, alle nederlandstalige documenten, alle 'turbos'...</p>
					</aside>
				</section>

				<section data-background="http://s3.amazonaws.com/crunchbase_prod_assets/assets/images/original/0018/2843/182843v2.png" data-background-transition="slide">
					<h1>Analyse</h1>
				</section>

				<section data-background="http://artchivebycarteblanche.com/wp-content/uploads/2013/12/Train-Station-Night-Walpaper-HD.jpg" data-background-transition="slide">
					<h1>In near realtime</h1>
					<aside class="notes">
						<p>Near realtime: Bij ES refresh --&gt; buffer geschreven naar Lucene segmenten</p>
					</aside>
				</section>

<!--Lucene-->
				<section>
					<img src="https://drupal.org/files/project-images/lucene_0.png" alt="Lucene" class="raw" />
				</section>

				<section>
					<h2></h2>
				</section>

				<section>
					<h2>Inverted Index</h2>

					<table class="fragment">
					  <tr>
					    <th>Token</th>
					    <th>Doc Freq.</th>
					    <th>Postings <small>Doc Ids</small></th>
					  </tr>
					  <tr>
					    <td>Anthony</td>
					    <td>2</td>
					    <td>1, 2</td>
					  </tr>
					  <tr>
					    <td>Brutus</td>
					    <td>1</td>
					    <td>5</td>
					  </tr>
					  <tr>
					    <td>Caesar</td>
					    <td>2</td>
					    <td>2, 3</td>
					  </tr>
					  <tr>
					    <td>Calpurnia</td>
					    <td>2</td>
					    <td>4, 5</td>
					  </tr>
					</table>
				</section>

				<section>
					<h2 class="fragment current-visible">Indexing</h2>

					<div class="schema">
						<div class="s arrow fragment">
							<p><small>Index a document</small></p>
							<div class="arrow">
								<div class="line"></div>
								<div class="point"></div>
							</div>
						</div>
						<div class="s buffer fragment">
							<h5>Buffer</h5>
							<div class="docs">
								<div class="doc fragment">d</div>	
								<div class="doc fragment">d</div>	
								<div class="doc fragment">d</div>	
							</div>
						</div>
						<div class="s arrow fragment flush">
							<p><small>Lucene flush</small></p>
							<div class="arrow">
								<div class="line"></div>
								<div class="point"></div>
							</div>
							<div class="doc">d</div>	
							<div class="doc">d</div>	
							<div class="doc">d</div>
						</div>
						<div class="s segment fragment">
							<h5>Segment</h5>
						</div>
						<div class="s segment segment2 fragment">
							<h5>Segment</h5>
						</div>
						<div class="s segment segment3 fragment">
							<h5>Segment</h5>
						</div>
					</div>

					<aside class="notes"> 
						Transaction Log naast Buffer (specifiek ES) - Garandeerd durability + vergemakkelijkt relocation/recovery

					</aside>
				</section>

				<section>
					<h2>Segments &amp; Search</h2>
					<ul>						
						<li>Sequentiele zoekopdracht</li>						
						<li>Soft deletes</li>
						<li>Segmenten zijn duur, af en toe mergen</li>
					</ul>

					<aside class="notes">
						Segmenten zijn immutable
						Deletes worden bijgehouden in een aparte lijst per segment
						Mergen, telkens twee kleinste segmenten samenvoegen
						Mergen, tegelijkertijd ook garbage collection van de soft deleted documents
					</aside>
				</section>

<!--Demo-->
				<section>
					<h2>Demo: KBCS Research Documents</h2>
						<ol>
							<li>Resultaat</li>
							<li>PDF verwerking</li>
							<li>Mapping</li>
							<li>Zoekopdracht</li>
						</ol>
				</section>

<!--Index en Search-->
				<section>
					<h1>Zoeken en vinden</h1>
				</section>

				<section>
					<h1>Analyzer</h1>
				</section>

				<section>
					<h1>Analyzer</h1>
					<h3 class="mtop">Tokenizer</h3>
					<p class="fragment">standard, keyword, letter, whitespace, regex&hellip;</p>					
					<h3 class="mtop">Token Filter</h3>
					<p class="fragment">lowercase, stopword, ngram, shingle, stemming, phonetic, asciifolding, elision, synonym, length&hellip;</p>

					<aside class="notes">
						Tokenizer keyword: volledige input als een (1) token
						Tokenizer letter: divides text at non-letters
					</aside>
				</section>

				<section>
					<h2>Analyzer config</h2>
					<pre><code data-trim>
							{"settings": {
    "analysis": {
        "analyzer": {
            "nl_idx_analyzer": {
                "type": "custom",
                "tokenizer": "whitespace",
                "filter": ["trim", "pdf_word_parts","short_words","pdf_unique_tokens","lowercase","nl_stop","asciifolding"]
            }
        },
        "filter": {
            "nl_stop": {
                "type": "stop",
                "stopwords": ["_dutch_"]
            },
            "pdf_word_parts": {
                "type": "pattern_capture",
                "preserve_original": true,
                "patterns": [
                    "(\\p{Ll}+|\\p{Lu}\\p{Ll}+|\\p{Lu}+)",
                    "(\\S+)[^a-zA-Z0-9]+",
                    "(\\w+)"
                ]
            },
            "pdf_unique_tokens": {
                "type": "unique",
                "only_on_same_position": true
            },
            "short_words": {
                "type": "length",
                "min": 3
            }
        }
    }
}}
						</code></pre>

				</section>	

				<section>
					<h1>Analyzers Demo</h1>
				</section>


				<section>
					<h1>Relevantie</h1>
				</section>

				<section>
					<h2>Term Frequency<h2>
					<hr>
					<h2>Inverse Document Frequency</h2>
				</section>

				<section>
					<h2>Lucene Ranking Formula</h2>
					<img src="img/rankingformula.png" />
				</section>

				<section>
					<h2>Explaining</h2>

					<pre><code>TODO explain API voorbeeld (p113)</code></pre>

					<aside class="notes">
						Search API vs Explain API
						/company/_search {"explain": true, query}
						/company/1/_explain {query}
					</aside>
				</section>


<!--In productie-->
				<section data-background="http://lenergiedavancer.com/wp-content/uploads/2012/02/NynashamnRefineryNight.jpg">
					<h1 class="emph">In productie</h1>
				</section>

				<section>
					<h2>Master node election</h2>
					<pre><code>minimum_master_nodes = {quorum} //quorum = helft + 1</code></pre>
					<p>Via API toegankelijk bij aanpassing cluster grootte.</p>
				</section>

				<section>
					<h2>Shard Allocation</h2>
					<p>TODO hoe werkt het?</p>
					<p>Awareness</p>
				</section>

				<section>
					<h2>Node Types</h2>
					<ul>
						<li><strong>Data Node</strong></li>
						<li><strong>Master Node</strong></li>
						<li>Client Node</li>
						<li>Tribe Node</li>
					</ul>
				</section>

				<section>
					<h2>Cluster health</h2>
					<ol>
						<li>green</li>
						<li>yellow</li>
						<li>red</li>
					</ol>

					<aside class="notes">
					On the shard level, a red status indicates that the specific shard is not allocated in the cluster, <br>yellow means that the primary shard is allocated but replicas are not,<br>and green means that all shards are allocated. <br><br>
					Bij rood is de cluster nog functioneel, de resultaten uit de niet-gealloceerde shard komen gewoon niet terug.
					</aside>
				</section>	

				<section>
					<h2>Capacity Planning</h2>
					<p>Number of shards per index</p>
				</section>

				<section>
					<h2>ES_HEAP_SIZE</h2>
					<p>De helft van het geheugen van de hostmachine.</p>
					<p>Niet meer dan 30Gb</p>
					<p class="mtop">Indien te weinig (OutOfMemory) &#8594; meer nodes</p>

					<aside class="notes">
						helft geheugen - OS zal de rest als file system cache gebruiken<br />
						30gb - the JVM can compress pointers from 64bit to 32bit
					</aside>
				</section>

				<section>
					<h1>SWAP nooit</h1>
					<pre><code>bootstrap.mlockall = true</code></pre>
					<pre><code>ulimit -l unlimited</code></pre>					
					<p><small>(Enkel *NIX)</small></p>
					<p class="mtop">Let op, dit kan de JVM doen crashen bij te weinig geheugen.</p>
				</section>

				<section>
					<h2>Hardware</h2>
				</section>

				<section>
					<h2>JVM</h2>
					<p>OpenJDK of OracleJDK</p>
					<p>7 of hoger</p>
					<p>En <em>niet</em> 7u25 en 7u51</p>
					<p class="mtop">Xms = Xmx</p>


					<aside class="notes">
						Xms - JVM memory allocation pool size
					</aside>					
				</section>

				<section>
					<h2>HTTP</h2>
					<p>Long live http connections (nginx)</p>
				</section>

				<section>
					<h1>Marvel</h1>
				</section>





				<section>
					<h2>'Vergeten' features</h2>
					<ul>
						<li>Geolocation support</li>
						<li>Aggregations</li>
						<li>Document relations: Nested fields - Parent/Child documents</li>
						<li>Warmer API</li>
						<li>Percolation API</li>
						<li>Suggestions</li>
						<li>Snapshot/Restore</li>
						<li>Geen 'Write Amplification' op SSDs</li>
					</ul>
				</section>


				<section data-background="http://upload.wikimedia.org/wikipedia/commons/4/44/Suorvajaure_in_stora_sjofallet_park.jpg">
					<h1 class="emph">Bedankt</h1>
				</section>












				
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>
		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
				backgroundTransition: 'slide',

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

		<script>
			$( document ).ready(function() {
 
 				$(document).keydown(function (e) { 				
		   			$(".buffer .docs").css({ opacity: ($(".flush").hasClass("visible") ? 0 : 1) });
		   			$(".flush .doc").css({ opacity: ($(".segment").hasClass("visible") ? 0 : 1) });			   		
 				});			   
			 
			});
		</script>

	</body>
</html>
